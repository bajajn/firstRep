<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<link rel="stylesheet" href="css/data_analysis.css">
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/dc.css">
</head>
<title>Data Analysis</title>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Data Analysis</a>
        </div>
        <!-- 
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Dashboard</a></li>
            <li><a href="#">Settings</a></li>
            <li><a href="#">Profile</a></li>
            <li><a href="#">Help</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <input type="text" class="form-control" placeholder="Search...">
          </form>
        </div>
         -->
      </div>
      </nav>
      
      
      <div class="container-fluid">
      <div class="row">
      	<!--  
      	<div class="col-sm-2 col-md-1 sidebar">
          <ul class="nav nav-sidebar">
            <li class="active"><a href="#">Overview <span class="sr-only">(current)</span></a></li>
            <li><a href="#">Reports</a></li>
            <li><a href="#">Analytics</a></li>
            <li><a href="#">Export</a></li>
          </ul>
        </div>
        -->
        <div class="col-sm-12 col-md-12 main jumbotron" style = "padding-left: 0px; padding-right: 0px;">
          
          	<div class = "container" style="margin-left: 10px; margin-right:10px;">
          		<div class="row">
          		        <div class="col-sm-12 col-md-12">
          				<div class="btn-group" data-toggle="buttons">
						  <label class="btn btn-primary ">
						    <input type="radio" name="options" id="day" value="day" autocomplete="off"> Daily
						  </label>
						  <label class="btn btn-primary active" >
						    <input type="radio" name="options" id="month" value="month" autocomplete="off" checked> Monthly
						  </label>
						  <label class="btn btn-primary">
						    <input type="radio" name="options" id="quater" value ="quater" autocomplete="off"> Quaterly
						  </label>
						  <label class="btn btn-primary">
						    <input type="radio" name="options" id="year" value = "year" autocomplete="off"> Yearly
						  </label>
						  
						</div>
					</div>
				</div>
	        	<div class="row">
          			<div class="col-sm-6 col-md-6">
          					<div class="panel-body" id="total_line_chart">
          					<!-- <svg id="trends_svg" width="100%" height="100%"></svg>  -->
          					<h4>Count Chart</h4>
          					</div>
          			</div>

          			<div class="col-sm-6 col-md-6">
          					<div class="panel-body" id="percent_chart">
          					<!-- <svg id="trends_svg" width="100%" height="100%"></svg>  -->
          					<h4>Percent Chart</h4>
          					</div>
          					
          			</div>
													
          		</div>
          		
          		<div class="row">
          			<div class="col-sm-3 col-md-3">
          					<div class="row">
	          					<div class="panel-body" id="category_chart">
											<h4>Category Chart</h4>
											<div class="reset filter_top" style="visibility: hidden">
												<font color="teal" style="font-family: Verdana;">Selected:</font> <span class="filter"></span> <a
													href="javascript:categoryChart.filterAll();dc.redrawAll();">Reset</a>
											</div>
	          					
	          					<!-- <svg id="trends_svg" width="100%" height="100%"></svg>  -->
	          					</div>
          					</div>
          					<div class = "row">
	          					<div class="panel-body" id="status_chart">
											<h4>Status Chart</h4>
	          								<div class="reset filter_top" style="visibility: hidden;">
												<font color="teal" style="font-family: Verdana;">Selected:</font> <span class="filter"></span> <a
													href="javascript:statusChart.filterAll();dc.redrawAll();">Reset</a>
											</div>
	          					<!-- <svg id="trends_svg" width="100%" height="100%"></svg>  -->
	          					</div>
          					</div>
          			</div>
          			
          			<div class="col-sm-9 col-md-9">
          				<div class="panel-body" id="map_chart">
          				<h4>Countries</h4>
          				<div class="reset filter_top" style="visibility: hidden;">
												<font color="teal" style="font-family: Verdana;">Selected:</font> <span class="filter"></span> <a
													href="javascript:mapChart.filterAll();dc.redrawAll();">Reset</a>
											</div>
						</div>
          			</div>
          			
          		</div>
          		
          		<div class="row">
          			<div class="col-sm-12 col-md-12">
          				<table id="data_table" class="table table-striped table-bordered table-hover">
          					<thead>
          					<tr>
          						<th>
          						#
          						</th>
          						<th>
          						Count(Total)
          						</th>
          						<th>
          						Count(Processed)
          						</th>
          						<th>
          						%(Processed)
          						</th>
          						<th>
          						Count(In-Repair)
          						</th>
          						<th>
          						%(In-Repair)
          						</th>
          						<th>
          						Count(Failed)
          						</th>
          						<th>
          						%(Failed)
          						</th>
          						<th>
          						Count(Cat1)
          						</th>
          						<th>
          						%(Cat1)
          						</th>
          						<th>
          						Count(Cat2)
          						</th>
          						<th>
          						%(Cat2)
          						</th>
          						<th>
          						Count(Cat3)
          						</th>
          						<th>
          						%(Cat3)
          						</th>
          					</tr>
          					</thead>
          					<tbody>
          					</tbody>
          				</table>
          			</div>
          		</div>
          		

 
				
          		
          		
          		<nav class="navbar navbar-fixed-bottom">
          			<div class="col-sm-12 col-md-12 ">
          					<div class="panel-body" id="time_line">
          					<div class="reset" style="visibility: hidden; font-size: 10px">
												Selected: <span class="filter"></span> <a
													href="javascript:timeline.filterAll();dc.redrawAll();">Reset</a>
							</div>
          					</div>
          			</div>
          		</nav>
          		

          		
          	</div>

        </div>
      </div>
      </div>

    
<script src="js/jquery-2.2.2.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/d3.min.js"></script>
<!-- <script src="js/d3-tip/index.js"></script> -->
<script src="js/crossfilter.min.js"></script>
<script src="js/dc.min.js"></script>
<script>
/*
http://jsfiddle.net/djmartin_umich/9VJHe/
 */


function print_filter(filter){
	var f=eval(filter);
	if (typeof(f.length) != "undefined") {}else{}
	if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
	if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
	console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
} 

var parseDate = d3.time.format("%d-%m-%Y").parse;
var timeGroup = $("input[name=options]:checked").val();
$(document).ready(function(){
	$("input[name=options]").change(function(){
		timeGroup = $("input[name=options]:checked").val();
		calculateCharts(timeGroup);
		totalChart.render();
		percentChart.render();
	})
})



var rows={};
var ndx;

var totalChart = dc.compositeChart("#total_line_chart");
var percentChart = dc.compositeChart("#percent_chart");
var categoryChart = dc.pieChart("#category_chart");
var statusChart = dc.rowChart("#status_chart");
var timeline = dc.barChart("#time_line");
var mapChart =  dc.geoChoroplethChart("#map_chart");


var cat1Colour = '#0D861F';
var cat2Colour = '#3A59BF';
var cat3Colour = 'teal';
var totalColour = 'black';
var processedColour = '#32A243';
var inRepairColour = 'steelblue';
var failureColour = '#C1091E';

d3.json("model/countries.geo.json", function(error, world){

	
	d3.json("model/data.json", function(error, dataValues) {
		console.log(error);
		rows=dataValues.data;
		
		rows.forEach(function(d) {
			d.dateObj = parseDate(d.date)
			d.monthDate = d3.time.month.floor(d.dateObj);
			d.yearDate=d3.time.year.floor(d.dateObj);
		});
		
		ndx = crossfilter(rows);
		var all = ndx.groupAll();
		var dateDim = ndx.dimension(function (d) {return d.dateObj});
		
		calculateCharts(timeGroup);
		
		var categoryDim = ndx.dimension(function (d) { return d.type; });
		var statusDim = ndx.dimension(function (d) {return d.status;});
		var countryDim = ndx.dimension(function(d){return d.country;});
		
		
		var countryGrpCount = countryDim.group().reduceCount();
		var timelineGrp = dateDim.group().reduceCount();
		var typeTotal = categoryDim.group().reduceCount();
		var statusTotal = statusDim.group().reduceCount();
		
		

		
		statusChart.width(500)
	    .height(200)
	    //.margins({top: 20, left: 10, right: 10, bottom: 20})
	    .group(statusTotal)
	    .dimension(statusDim)
	    .gap(20)
	    .label(
	    		function(v){
	    			if (v.key == "processed") return "Processed";
	    			if (v.key == "in-repair") return "In-Repair";
	    			if (v.key == "failure") return "Failed";
	    			})
		//.x(d3.scale.linear().domain([minDate,maxDate]))
	    .title(function (v) { return "Count: "+v.value; })
	    .elasticX(true)
	    //.renderTitleLabel(true)
	    //.ordinalColors([processedColour,inRepairColour, failureColour])
	    .controlsUseVisibility(true)
	    .colorCalculator(function(d){
	    	var colorVal;
    		switch(d.key){
    			case "processed":
    				colorVal = processedColour;
    				break;
    			case "in-repair":
    				colorVal = inRepairColour;
    				break;
    			case "failure":
    				colorVal = failureColour;
    				break;
    			
    		}
    		return colorVal;
	    })
	    ;
		          
		categoryChart
		 .dimension(categoryDim)
		 .group(typeTotal)
		 .innerRadius(50)
		 .label(
	    		function(v){
	    			if (v.key == "C") return "Category 1";
	    			if (v.key == "F") return "Category 2";
	    			if (v.key == "C&F") return "Category 3";
	    			})
		 .renderLabel(true)
		 .title(function (v) { return "Count: "+v.value; })
		 .controlsUseVisibility(true)
		 //.renderLabel(false)
		 .colorCalculator(function(d){
	    	var colorVal;
    		switch(d.key){
    			case "C":
    				colorVal = cat1Colour;
    				break;
    			case "F":
    				colorVal = cat2Colour;
    				break;
    			case "C&F":
    				colorVal = cat3Colour;
    				break;
    			
    		}
    		return colorVal;
	    })
		 ;
	       
		
		mapChart
		.width(990)
	    .height(500)
	    .dimension(countryDim)
	    .group(countryGrpCount) 
	    .colors(d3.scale.category20())
	    .controlsUseVisibility(true)
	    .title(function(v){return v.key+"\nTotal Count: "+ (+v.value||0);})
	    //.colors(d3.scale.ordinal().range(['blue','brown']))
	    .projection(d3.geo.mercator())
		    .overlayGeoJson(world.features, "state", function (d1) {
		        return d1.id;
		    })
		.on('renderlet', function (chart) {
	        	chart.selectAll("path").attr("style", "stroke : #0f3e0e; stroke-width : .2;"); 
	          })  
		;				    
		    
		timeline
		.width(700)
		.height(80)
		.dimension(dateDim)
		.x(d3.time.scale().domain([d3.time.year.floor(dateDim.bottom(1)[0].dateObj), d3.time.year.ceil(dateDim.top(1)[0].dateObj)]))
		.brushOn(true)
		.controlsUseVisibility(true)
		.group(timelineGrp,"Trades/Day")
		.xAxisLabel('Select time range')
		;
		timeline.yAxis().tickFormat(function(v){return '';});
		
		dc.renderAll();
		
	});
	
	
	
	
	
});





function calculateCharts(timeGrp){
	var columnTags = '<td name="totalCount"></td><td name="processedCount"></td><td name="processedPercent"></td><td name="repairCount"></td>'+
	'<td name="repairPercent"></td><td name="failedCount"></td><td name= "failedPercent"></td><td name="cCount"></td><td name="cPercent"></td>'+
	'<td name="fCount"></td><td name="fPercent"></td><td name="cfCount"></td><td name="cfPercent"></td>';
	var dim;
	monthNameFormat = d3.time.format("%b");
	
	$("#data_table tbody").html('');
	switch(timeGrp) {
	    case "day":
	    	dim = ndx.dimension(function (d) { return d.dateObj; });
	    	totalChart.x(d3.time.scale().domain([d3.time.year.floor(dim.bottom(1)[0].dateObj), d3.time.year.ceil(dim.top(1)[0].dateObj)]));
	    	totalChart.xAxis().tickValues( d3.time.month.range(d3.time.year.floor(dim.bottom(1)[0].dateObj), d3.time.year.ceil(dim.top(1)[0].dateObj)),1);
	    	totalChart.xAxis().tickFormat(function(v){return monthNameFormat(v);});
	    	
	    	$("#data_table tbody").html('<tr><td colspan = "14">Disabled for selected time group</td></tr>');
	    	
	    	percentChart.x(d3.time.scale().domain([d3.time.year.floor(dim.bottom(1)[0].dateObj), d3.time.year.ceil(dim.top(1)[0].dateObj)]));
	    	percentChart.xAxis().tickValues( d3.time.month.range(d3.time.year.floor(dim.bottom(1)[0].dateObj), d3.time.year.ceil(dim.top(1)[0].dateObj)),1);
	    	percentChart.xAxis().tickFormat(function(v){return monthNameFormat(v);});
	        break;
	    case "month":
	    	dim = ndx.dimension(function (d) { return d.dateObj.getMonth(); });
	    	for(idx = 0; idx<12 ; idx++){
	    		$("#data_table tbody").append('<tr id="data_row_'+idx+'"><td>'+monthNameFormat(new Date(2001,idx,2))+'</td>'+columnTags+'</tr>');
	    	}
	    	totalChart.x(d3.scale.linear().domain([-1, 12]));
	    	totalChart.xAxis().tickValues([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]);
	    	totalChart.xAxis().tickFormat(function(v){if(v>=0 && v<12) return monthNameFormat(new Date(2001,v,2)); else return '';});
			percentChart.x(d3.scale.linear().domain([-1, 12]));
			percentChart.xAxis().tickValues([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]);
			percentChart.xAxis().tickFormat(function(v){ if(v>=0 && v<12) return monthNameFormat(new Date(2001,v,2)); else return '';});
	        break;
	    case "quater":
	    	
	        dim = ndx.dimension(function (d) {
	            var month = d.dateObj.getMonth();
	            if (month <= 2) {
	                return 1;
	            } else if (month > 2 && month <= 5) {
	                return 2;
	            } else if (month > 5 && month <= 8) {
	                return 3;
	            } else {
	                return 4;
	            }
	        });
	        
	        for(idx = 1; idx<=4 ; idx++){
	    		$("#data_table tbody").append('<tr id="data_row_'+idx+'"><td>Q'+idx+'</td>'+columnTags+'</tr>');
	    	}
	        totalChart.x(d3.scale.linear().domain([0,5])).xAxis().tickFormat(function(v){if([1,2,3,4].includes(v)) return 'Q'+v; else return '';});
	        totalChart.xAxis().tickValues([0, 1, 2, 3, 4, 5]);
	        
	        percentChart.x(d3.scale.linear().domain([0,5])).xAxis().tickFormat(function(v){if([1,2,3,4].includes(v)) return 'Q'+v; else return '';});
	        percentChart.xAxis().tickValues([0, 1, 2, 3, 4, 5]);
	        
	        break;
	    case "year":
	    	dim = ndx.dimension(function (d) { return d.dateObj.getFullYear(); });
	    	
	    	for(idx = dim.bottom(1)[0].dateObj.getFullYear(); idx<=dim.top(1)[0].dateObj.getFullYear() ; idx++){
	    		$("#data_table tbody").append('<tr id="data_row_'+idx+'"><td>'+idx+'</td>'+columnTags+'</tr>');
	    	}
	    	totalChart.x(d3.scale.linear().domain([  dim.bottom(1)[0].dateObj.getFullYear()-1, dim.top(1)[0].dateObj.getFullYear()+1]))
	    	.xAxis().tickFormat(function(v){if(Number.isInteger(v)) return v; else return '';});
	    	totalChart.xAxis().tickValues([dim.bottom(1)[0].dateObj.getFullYear()-1, dim.bottom(1)[0].dateObj.getFullYear(), dim.bottom(1)[0].dateObj.getFullYear()+1]);
	    	
	    	
	    	percentChart.x(d3.scale.linear().domain([  dim.bottom(1)[0].dateObj.getFullYear()-1, dim.top(1)[0].dateObj.getFullYear()+1]))
	    	.xAxis().tickFormat(function(v){if(Number.isInteger(v)) return v; else return '';});
	    	percentChart.xAxis().tickValues([dim.bottom(1)[0].dateObj.getFullYear()-1, dim.bottom(1)[0].dateObj.getFullYear(), dim.bottom(1)[0].dateObj.getFullYear()+1]);
	        break;

	} ;
	
	var yrStatGroup = dim.group().reduce(
		function (p,v){
			p.totalCount++;
			if(v.status == "processed") p.processedCount++;
			if(v.status == "in-repair") p.repairCount++;
			if(v.status == "failure") p.failureCount++;
			if(v.type == "C") p.cat1Count++;
			if(v.type == "F") p.cat2Count++;
			if(v.type == "C&F") p.cat3Count++;
			
			if(p.totalCount>0){
				p.processPercent = d3.format(".2f")((p.processedCount/p.totalCount)*100);
				p.failurePercent = d3.format(".2f")((p.failureCount/p.totalCount)*100);
				p.repairPercent = d3.format(".2f")((p.repairCount/p.totalCount)*100);
				p.cat1Percent = d3.format(".2f")((p.cat1Count/p.totalCount)*100);
				p.cat2Percent = d3.format(".2f")((p.cat2Count/p.totalCount)*100);
				p.cat3Percent = d3.format(".2f")((p.cat3Count/p.totalCount)*100);
			} else {
				p.processPercent = 0;
				p.failurePercent = 0;
				p.repairPercent = 0;
				p.cat1Percent = 0;
				p.cat2Percent = 0;
				p.cat3Percent = 0;
			}
			
			return p;
		},
		
		function (p,v){
			p.totalCount--;
			if(v.status == "processed") p.processedCount--;
			if(v.status == "in-repair") p.repairCount--;
			if(v.status == "failure") p.failureCount--;
			if(v.type == "C") p.cat1Count--;
			if(v.type == "F") p.cat2Count--;
			if(v.type == "C&F") p.cat3Count--;
			
			if(p.totalCount > 0){
				p.processPercent = d3.format(".2f")((p.processedCount/p.totalCount)*100);
				p.failurePercent = d3.format(".2f")((p.failureCount/p.totalCount)*100);
				p.repairPercent = d3.format(".2f")((p.repairCount/p.totalCount)*100);
				p.cat1Percent = d3.format(".2f")((p.cat1Count/p.totalCount)*100);
				p.cat2Percent = d3.format(".2f")((p.cat2Count/p.totalCount)*100);
				p.cat3Percent = d3.format(".2f")((p.cat3Count/p.totalCount)*100);
			}else {
				p.processPercent = 0;
				p.failurePercent = 0;
				p.repairPercent = 0;
				p.cat1Percent = 0;
				p.cat2Percent = 0;
				p.cat3Percent = 0;
			}
			
			
			
			return p;
		},
		
		function (){
			return {
				totalCount: 0,
				processedCount: 0,
				failureCount: 0,
				repairCount: 0,
				cat1Count: 0,
				cat2Count: 0,
				cat3Count: 0,
				processPercent: 0,
				failurePercent: 0,
				repairPercent: 0,
				cat1Percent: 0,
				cat2Percent: 0,
				cat3Percent: 0
            };
			
		}
	);
	
	
	
	totalChart
	.width(550).height(250)
	.dimension(dim)
	//.x(d3.time.scale().domain([d3.time.year.floor(dim.bottom(1)[0].dateObj), d3.time.year.ceil(dim.top(1)[0].dateObj)]))
	.elasticY(true)
	//.elasticX(true)
	.brushOn(false)
	.shareTitle(false)
	//.xAxis().ticks(d3.time.months)
	//.tickFormat(d3.time.format("%B"))
	.compose([
	          
	          dc.barChart(totalChart).group(yrStatGroup,"Cat1")
	          .valueAccessor(function (p) {
	              return p.value.cat1Count;
	          })
	          .centerBar(true)
	          .barPadding(3)
	          .title(function(v){if(timeGrp != 'day')   $('#data_row_'+v.key+' td[name="cCount"] ').text(v.value.cat1Count)  ;return "Category1: "+v.value.cat1Count;})
	          ,
	          
	          dc.barChart(totalChart).group(yrStatGroup,"Cat2")
	          .valueAccessor(function (p) {
	              return p.value.cat2Count;
	          })
		      .centerBar(true)
		      .barPadding(3)
		      .title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="fCount"] ').text(v.value.cat2Count)  ;return "Category2: "+v.value.cat2Count;})
		      ,		
		      
		      dc.barChart(totalChart).group(yrStatGroup,"Cat3")
	          .valueAccessor(function (p) {
	              return p.value.cat3Count;
	          })
		      .centerBar(true)
		      .barPadding(3)
		      .title(function(v){ if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="cfCount"] ').text(v.value.cat3Count)  ;return "Category3: "+v.value.cat3Count;})
		      ,		
	          
	          dc.lineChart(totalChart).group(yrStatGroup,"Total")
	          .valueAccessor(function (p) {
	              return p.value.totalCount;
	          })
	          .renderDataPoints({radius: 2, fillOpacity: 0.8, strokeOpacity: 0.8})
	          .title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="totalCount"] ').text(v.value.totalCount)  ;return "Total: "+v.value.totalCount;})
	          ,
	          
	          dc.lineChart(totalChart).group(yrStatGroup,"Processed")
	          .valueAccessor(function (p) {
	              return p.value.processedCount;
	          })
	          .renderDataPoints({radius: 2, fillOpacity: 0.8, strokeOpacity: 0.8})
	          .title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="processedCount"] ').text(v.value.processedCount); return "Processed: "+v.value.processedCount;})
	          ,
	          
	          dc.lineChart(totalChart).group(yrStatGroup,"In-Repair")
	          .valueAccessor(function (p) {
	              return p.value.repairCount;
	          })
	          .dashStyle([5,1])
	          .renderDataPoints({radius: 2, fillOpacity: 0.8, strokeOpacity: 0.8})
	          .title(function(v){if(timeGrp != 'day')  $('#data_row_'+v.key+' td[name="repairCount"] ').text(v.value.repairCount); return "In-Repair: "+v.value.repairCount;})
	          ,
	          
	          dc.lineChart(totalChart).group(yrStatGroup,"Failed")
	          .valueAccessor(function (p) {
	              return p.value.failureCount;
	          })
	          .dashStyle([5,0])
	          .renderDataPoints({radius: 2, fillOpacity: 0.8, strokeOpacity: 0.8})
	          .title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="failedCount"] ').text(v.value.failureCount); return "Failed: "+v.value.failureCount;})
	          ])
			  .on('renderlet', function (chart) {
	        	  var barWidth = chart.select("g.sub._0 rect").attr("width");
	        	  var rightMove = barWidth;
	        	  var leftMove = -barWidth;
	        	  var elements = chart.selectAll("g._0");
	        	chart.selectAll("g.sub._0").attr("transform", "translate(" + leftMove + ", 0)"); 
				chart.selectAll("g.sub._2").attr("transform", "translate(" + rightMove + ", 0)");
	          })  
	          .legend(dc.legend().x(450).y(10).itemHeight(13).gap(5))
	          .ordinalColors([cat1Colour,cat2Colour, cat3Colour, totalColour, processedColour, inRepairColour, failureColour]) 
	          .xAxisLabel('Time Group')
	          .yAxisLabel('Count')
	          .renderHorizontalGridLines(true)
	          .renderVerticalGridLines(true)
	          .shareColors(true)
	          ;
	
	
	totalChart.margins().right=100;
	
	percentChart
	.width(550).height(250)
	.dimension(dim)
	//.x(d3.time.scale().domain([d3.time.year.floor(dim.bottom(1)[0].dateObj), d3.time.year.ceil(dim.top(1)[0].dateObj)]))
	//.elasticY(true)
	.y(d3.scale.linear().domain([0, 100]))
	//.elasticX(true)
	.brushOn(false)
	.shareTitle(false)
	//.xAxis().ticks(d3.time.months)
	//.tickFormat(d3.time.format("%B"))
	.compose([
	          
	          
				dc.barChart(percentChart).group(yrStatGroup,"Cat1%")
				.valueAccessor(function (p) {
				    return p.value.cat1Percent;
				})
				.centerBar(true)
				.barPadding(3)
				.title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="cPercent"] ').text(v.value.cat1Percent+"%"); return "Category1: "+v.value.cat1Percent+"%";})
				,
				
				dc.barChart(percentChart).group(yrStatGroup,"Cat2%")
				.valueAccessor(function (p) {
				    return p.value.cat2Percent;
				})
				.centerBar(true)
				.barPadding(3)
				.title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="fPercent"] ').text(v.value.cat2Percent+"%"); return "Category2: "+v.value.cat2Percent+"%";})
				,
				
				dc.barChart(percentChart).group(yrStatGroup,"Cat3%")
				.valueAccessor(function (p) {
				    return p.value.cat3Percent;
				})
				.centerBar(true)
				.barPadding(3)
				.title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="cfPercent"] ').text(v.value.cat3Percent+"%"); return "Category3: "+v.value.cat3Percent+"%";})
				,

	          dc.lineChart(percentChart).group(yrStatGroup,"Processed%")
	          .valueAccessor(function (p) {
	              return p.value.processPercent;
	          })
	          .renderDataPoints({radius: 2, fillOpacity: 0.8, strokeOpacity: 0.8})
	          .title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="processedPercent"] ').text(v.value.processPercent+"%"); return "Processed: "+v.value.processPercent+"%";})
	          ,
	          
	          dc.lineChart(percentChart).group(yrStatGroup,"In-Repair%")
	          .valueAccessor(function (p) {
	              return p.value.repairPercent;
	          })
	          .dashStyle([5,1])
	          .renderDataPoints({radius: 2, fillOpacity: 0.8, strokeOpacity: 0.8})
	          .title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="repairPercent"] ').text(v.value.repairPercent+"%"); return "In-Repair: "+v.value.repairPercent+"%";})
	          ,
	          
	          dc.lineChart(percentChart).group(yrStatGroup,"Failure%")
	          .valueAccessor(function (p) {
	              return p.value.failurePercent;
	          })
	          .renderDataPoints({radius: 2, fillOpacity: 0.8, strokeOpacity: 0.8})
	          .title(function(v){if(timeGrp != 'day') $('#data_row_'+v.key+' td[name="failedPercent"] ').text(v.value.failurePercent+"%"); return "Failed: "+v.value.failurePercent+"%";})
	          ])
	          .on('renderlet', function (chart) {
	        	  var barWidth = chart.select("g.sub._0 rect").attr("width");
	        	  var rightMove = barWidth;
	        	  var leftMove = -barWidth;
	        	  //var axisLength = chart.xAxisLength();
	        	 chart.selectAll("g.sub._0").attr("transform", "translate(" + leftMove + ", 0)"); 
				chart.selectAll("g.sub._2").attr("transform", "translate(" + rightMove + ", 0)");
	          })
	          .legend(dc.legend().x(450).y(10).itemHeight(13).gap(5))
	          .ordinalColors([cat1Colour,cat2Colour, cat3Colour, processedColour, inRepairColour, failureColour])
	          .xAxisLabel('Time Group')
	          .yAxisLabel('Percent')
	          .renderHorizontalGridLines(true)
	          .renderVerticalGridLines(true)
	          .shareColors(true)
	          ;
	
	percentChart.margins().right=100;
	
}



/*
function testFunction(d){
	pieTip.show(d);
	var testRowChart = dc.rowChart('#rowchart_'+d.data.key);
	testRowChart.width(200)
    .height(200)
    //.margins({top: 20, left: 10, right: 10, bottom: 20})
    .transitionDuration(750)
    .group(monthGrpProcessed)
    .dimension(monthDim1)
	.x(d3.time.scale().domain([minDate,maxDate]))
    //.colors(expenseColors)
    //.renderLabel(true)
    //.gap(9)
    .title(function (d) { return ""; })
    .elasticX(true);
	
	testRowChart.render();
    //.xAxis().ticks(5).tickFormat(d3.format("s"));


}

		d3.selectAll(".pie-slice").call(pieTip);
	    d3.selectAll(".pie-slice").on('mouseover', testFunction)
	        .on('mouseout', pieTip.hide);




	    var pieTip = d3.tip()
	                      .attr('class', 'd3-tip')
	                      .offset([30, 30])
	                      .html(function (d) { 
	                    	  return "<div id ='rowchart_"+d.data.key+"'></div>";
	                    	  //return "<span style='color: #f0027f'>" +  d.data.key + "</span> : "  + d.value;
	                    	  });
		
*/




/*
//working code
var trendsSvg = d3.select("#trends_svg");

var dateExtent;
var format = d3.time.format("%d-%m-%Y");
d3.json("model/data.json", function(error, dataValues) {
	
	dateExtent= d3.extent(dataValues.data, function (el) {
		el.dateTime = format.parse(el.date);
		return el.dateTime;
		});
 	console.log("Date Extent is "+dateExtent);
 	mindate = d3.time.month.floor(dateExtent[0]);
 	maxdate = d3.time.month.ceil(dateExtent[1]);
	
	var xScale = d3.time.scale().domain([mindate, maxdate]).range([60, 800]);
	var xAxis = d3.svg.axis().scale(xScale).ticks(d3.time.months).tickFormat(d3.time.format("%B")).tickSubdivide(true);

	//xAxis = d3.svg.axis().scale(xScale);

	trendsSvg.append("svg:g")
	.call(xAxis);

});
*/


</script>

</body>
</html>